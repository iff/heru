#!/usr/bin/env node

require('colors');
var heru = require('../'), Node = heru.Node;

var program = require('commander');
program
  .version(heru.Version.yellow)
  .option('-l, --library <path>', 'specify the path to your library', String, process.env.PWD)
  .option('-n, --node <node>', 'specify the node', String)
  .parse(process.argv);

global.library = program.library;

var join = require('path').join
  , realpathSync = require('fs').realpathSync
  , inspect = require('util').inspect;


// Load the configuration for the given node.
function loadNode(hostname) {
  var path = hostname.split('.').reverse();
  return require(join(program.library, 'nodes', path.join('/')));
}


// There is no way to get the FQDN in node. The user needs to supply the
// hostname on the commandline.
spec = loadNode(program.node);
node = new Node(program.node, spec);


function dumpError(err, indent) {
  if (err) console.log(err.message);
  if (!err.children) return;

  err.children.forEach(function(err) {
    dumpError(err, indent + 1);
  });
}

// This is where it comes all together. Ideally, the verify step would not
// perform any changes on the system. In reality it runs certain write
// operations. Somebody should fix that.
node.verify().when(function(err) {
  if (err) {
    if ('--dry-run' in process.argv) {
      console.log("dry run mode");
      dumpError(err, 0);
    } else {
      console.log('Node is in incomplete state. Taking corrective measures.');
      dumpError(err, 0);
      node.amend().when(function(err) {
        if (err) dumpError(err, 0);
      });
    }
  } else {
    console.log('Node verified. Nothing to do');
  }
})
